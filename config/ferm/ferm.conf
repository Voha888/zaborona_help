@def $VPN = (
zaborona+
);

@def $WAN_4 = eth0;
@def $WAN_6 = eth0;
@def $VPN_ADDR_4 = (
192.168.224.0/22
192.168.228.0/22
192.168.232.0/22
192.168.236.0/22
192.168.240.0/22
192.168.244.0/22
192.168.248.0/22
192.168.252.0/22
);

@def $ALLOWED_NETWORKS_V4 = (
74.82.42.42/32
8.8.8.8/32
8.8.4.4/32
1.1.1.1/32
1.0.0.1/32
176.103.130.130/32
176.103.130.131/32
176.103.130.132/32
176.103.130.134/32
176.103.130.136/32
176.103.130.137/32
5.45.192.0/18
5.255.192.0/18
37.9.64.0/18
37.140.128.0/18
77.75.152.0/21
77.88.0.0/18
84.201.128.0/18
87.250.224.0/19
93.158.128.0/18
95.108.128.0/17
100.43.64.0/19
109.235.160.0/21
130.193.32.0/19
141.8.128.0/18
149.5.244.0/22
154.47.0.0/16
178.154.128.0/17
185.32.184.0/22
185.71.76.0/22
199.21.96.0/22
199.36.240.0/22
213.180.192.0/19
5.61.16.0/21
5.61.232.0/21
79.137.128.0/18
94.100.176.0/20
95.163.32.0/19
95.163.248.0/21
128.140.168.0/21
178.22.88.0/21
178.237.16.0/20
185.5.136.0/22
185.16.148.0/22
185.16.244.0/22
188.93.56.0/21
194.186.63.0/24
195.211.20.0/22
195.211.128.0/22
195.218.168.0/24
208.87.92.0/22
217.20.144.0/20
217.69.128.0/20
185.6.244.0/22
185.30.176.0/22
195.218.190.0/23
95.163.144.0/24
5.181.60.0/22
45.84.128.0/22
45.136.20.0/22
79.137.174.0/23
79.137.240.0/21
85.192.32.0/22
87.240.128.0/18
89.208.84.0/16
93.186.224.0/20
95.142.192.0/19
95.213.0.0/18
185.16.246.0/23
185.29.130.0/24
185.32.248.0/22
185.187.63.0/24
185.226.52.0/22
213.219.212.0/22
193.0.170.0/23
50.117.0.0/27
62.213.108.142/32
88.217.190.96/27
193.84.255.0/24
83.137.54.41/32
85.192.48.0/21
88.210.0.0/18
89.20.144.0/21
89.222.152.0/21
91.200.28.0/22
91.227.52.0/23
94.143.52.0/22
185.76.252.0/22
194.88.208.0/23
195.177.205.0/24
212.118.32.0/19
51.254.201.70/32
145.239.95.188/32
151.80.149.182/32
217.182.78.61/32
217.182.157.141/32
91.217.153.39/32
52.28.234.188/32
89.184.80.139/32
91.203.69.175/32
104.31.94.209/32
104.31.95.209/32
104.24.104.202/32
104.24.105.202/32
104.28.30.164/32
104.28.31.164/32
192.88.99.0/24
51.254.96.26/32
54.36.30.17/32
4.31.208.86/32
4.59.181.140/32
77.74.176.0/22
93.159.228.0/22
185.85.8.0/21
212.5.110.0/24
218.213.144.7/32
178.248.232.0/21
213.79.65.32/27
195.93.246.0/23
186.2.163.12/32
178.210.84.61/32
80.247.32.208/32
87.250.251.92/24
104.20.73.219/32
104.20.74.219/32
172.67.3.106/32
178.248.233.60/32
82.202.184.0/21
45.60.34.164/32
45.60.40.164/32
194.84.83.128/27
194.84.120.160/27
193.232.151.138/32
104.26.2.111/32
104.26.3.111/32
172.67.70.154/32
193.26.19.0/24
80.68.240.0/20
185.72.228.0/22
35.186.224.25/32
5.9.2.89/32
5.45.192.0/18
5.61.16.0/21
5.61.232.0/21
5.101.127.9/32
5.101.152.102/32
5.135.247.193/32
5.153.134.34/32
5.178.80.46/32
5.181.60.0/22
5.200.52.28/32
5.253.86.57/32
5.255.192.0/18
31.28.24.115/32
31.28.169.70/32
31.31.198.139/32
31.133.58.6/32
31.133.58.78/32
31.170.165.202/32
34.249.182.166/32
37.9.64.0/18
37.140.128.0/18
37.140.192.112/32
37.140.192.206/32
37.143.11.121/32
37.230.252.84/32
45.60.40.164/32
45.66.9.183/32
45.84.128.0/22
45.136.20.0/22
46.4.89.218/32
51.254.201.70/32
52.211.235.33/32
52.222.174.72/32
52.222.174.159/32
52.222.174.160/32
52.222.174.163/32
54.77.76.190/32
66.212.246.166/32
77.74.176.0/21
77.75.152.0/21
77.87.197.175/32
77.88.0.0/18
77.222.40.16/32
77.222.56.73/32
77.222.62.134/32
78.24.217.132/32
78.155.219.132/32
79.137.139.0/24
79.137.142.0/24
79.137.157.0/24
79.137.174.0/23
79.137.183.0/24
79.137.240.0/21
80.239.201.81/32
80.245.112.15/32
80.247.32.206/32
80.247.32.208/32
81.177.103.94/32
81.177.140.32/32
81.200.116.94/32
82.146.58.99/32
82.148.20.65/32
82.202.160.193/32
82.202.184.0/23
82.202.189.118/32
82.202.189.119/32
82.202.190.240/32
82.202.197.243/32
82.202.224.195/32
82.202.249.18/32
82.202.249.102/32
82.202.249.227/32
83.137.54.41/32
84.50.110.180/32
85.143.212.222/32
85.192.32.0/22
85.192.32.129/32
85.192.48.0/21
87.226.218.132/32
87.236.16.9/32
87.236.16.12/32
87.236.16.33/32
87.236.16.53/32
87.236.16.96/32
87.236.16.197/32
87.240.128.0/18
87.250.224.0/19
88.210.0.0/18
88.212.251.4/32
89.20.144.0/21
89.108.90.170/32
89.108.121.15/32
89.108.123.53/32
89.208.84.0/22
89.208.196.0/22
89.208.208.0/22
89.208.216.0/23
89.208.220.0/22
89.208.228.0/22
89.222.152.0/21
91.103.64.0/21
91.109.250.119/32
91.194.2.88/32
91.200.28.0/22
91.205.164.53/32
91.214.81.148/32
91.217.153.39/32
91.218.19.28/32
91.222.157.1/32
91.222.157.2/32
91.222.157.3/32
91.222.157.4/32
91.222.157.5/32
91.222.157.6/32
91.222.157.7/32
91.222.157.8/32
91.223.118.6/32
91.223.118.250/32
91.227.52.0/23
91.230.61.4/32
91.239.233.254/32
92.53.96.178/32
92.53.98.191/32
92.53.98.245/32
92.53.118.140/32
92.119.112.135/32
92.119.113.115/32
93.157.9.180/32
93.157.9.254/32
93.157.10.114/32
93.158.128.0/18
93.159.224.0/21
93.186.224.0/21
93.186.232.0/21
94.23.103.5/32
94.100.176.0/20
94.103.81.73/32
94.125.59.25/32
94.143.52.0/22
94.158.47.243/32
95.108.128.0/17
95.142.192.0/20
95.163.32.0/19
95.163.94.154/32
95.163.94.181/32
95.163.94.202/32
95.163.94.242/32
95.163.95.12/32
95.163.95.32/32
95.163.95.62/32
95.163.95.68/32
95.163.95.112/32
95.163.180.0/22
95.163.208.0/23
95.163.210.0/23
95.163.212.0/22
95.163.216.0/22
95.163.248.0/21
95.173.128.111/32
95.173.145.58/32
95.173.157.48/32
95.173.157.61/32
95.183.13.81/32
95.213.0.0/18
95.213.64.0/18
95.213.214.82/32
100.43.64.0/19
103.224.212.222/32
104.16.12.16/32
104.16.13.16/32
104.16.24.7/32
104.16.24.24/32
104.16.25.7/32
104.16.25.24/32
104.16.36.28/32
104.16.37.28/32
104.16.48.8/32
104.16.49.8/32
104.16.57.47/32
104.16.58.18/32
104.16.58.47/32
104.16.59.18/32
104.16.75.34/32
104.16.76.34/32
104.16.103.41/32
104.16.104.41/32
104.16.241.5/32
104.16.242.5/32
104.17.61.45/32
104.17.106.19/32
104.17.107.19/32
104.18.0.246/32
104.18.1.246/32
104.18.2.179/32
104.18.3.179/32
104.18.6.99/32
104.18.6.157/32
104.18.7.99/32
104.18.7.157/32
104.18.8.161/32
104.18.9.161/32
104.18.10.175/32
104.18.11.175/32
104.18.18.26/32
104.18.18.115/32
104.18.18.166/32
104.18.18.225/32
104.18.19.26/32
104.18.19.115/32
104.18.19.166/32
104.18.19.225/32
104.18.22.194/32
104.18.22.206/32
104.18.23.194/32
104.18.23.206/32
104.18.30.244/32
104.18.31.244/32
104.18.32.61/32
104.18.33.61/32
104.18.34.86/32
104.18.34.142/32
104.18.35.86/32
104.18.35.142/32
104.18.44.47/32
104.18.45.47/32
104.18.46.252/32
104.18.47.252/32
104.18.52.221/32
104.18.53.221/32
104.18.56.187/32
104.18.57.187/32
104.18.79.50/32
104.19.146.85/32
104.19.147.85/32
104.20.73.219/32
104.20.74.219/32
104.22.48.165/32
104.22.49.165/32
104.24.100.21/32
104.24.101.21/32
104.24.102.45/32
104.24.102.160/32
104.24.102.229/32
104.24.103.45/32
104.24.103.160/32
104.24.103.229/32
104.24.104.2/32
104.24.105.2/32
104.24.110.214/32
104.24.111.214/32
104.24.112.187/32
104.24.113.187/32
104.24.114.105/32
104.24.115.105/32
104.24.116.186/32
104.24.117.186/32
104.24.120.251/32
104.24.121.251/32
104.24.124.128/32
104.24.124.206/32
104.24.124.252/32
104.24.125.128/32
104.24.125.206/32
104.24.125.252/32
104.25.193.39/32
104.25.194.39/32
104.26.0.193/32
104.26.1.193/32
104.26.2.24/32
104.26.2.239/32
104.26.3.24/32
104.26.3.239/32
104.26.6.112/32
104.26.7.112/32
104.26.10.21/32
104.26.11.21/32
104.26.12.145/32
104.26.13.145/32
104.26.14.128/32
104.26.14.155/32
104.26.15.128/32
104.26.15.155/32
104.27.130.134/32
104.27.131.134/32
104.27.136.215/32
104.27.137.215/32
104.27.142.249/32
104.27.143.249/32
104.27.148.44/32
104.27.149.44/32
104.27.154.140/32
104.27.155.140/32
104.27.156.92/32
104.27.157.92/32
104.27.162.17/32
104.27.163.17/32
104.27.170.3/32
104.27.171.3/32
104.27.172.205/32
104.27.173.205/32
104.27.178.59/32
104.27.178.152/32
104.27.179.59/32
104.27.179.152/32
104.27.182.148/32
104.27.182.214/32
104.27.183.148/32
104.27.183.214/32
104.27.186.47/32
104.27.187.47/32
104.27.188.156/32
104.27.189.156/32
104.27.190.91/32
104.27.191.91/32
104.28.0.8/32
104.28.1.8/32
104.28.2.25/32
104.28.2.158/32
104.28.3.25/32
104.28.3.158/32
104.28.6.29/32
104.28.6.177/32
104.28.7.29/32
104.28.7.177/32
104.28.8.203/32
104.28.9.203/32
104.28.14.128/32
104.28.14.250/32
104.28.15.128/32
104.28.15.250/32
104.28.16.187/32
104.28.17.187/32
104.28.24.187/32
104.28.25.187/32
104.28.28.176/32
104.28.28.252/32
104.28.29.176/32
104.28.29.252/32
104.31.80.243/32
104.31.81.243/32
104.31.84.40/32
104.31.85.40/32
104.31.88.55/32
104.31.89.55/32
104.31.90.12/32
104.31.91.12/32
104.31.94.224/32
104.31.95.224/32
108.128.77.35/32
109.235.160.0/21
109.236.89.250/32
109.254.249.114/32
116.203.123.103/32
127.0.0.1/32
128.140.168.0/21
134.0.116.36/32
134.122.55.2/32
136.243.66.123/32
138.201.132.163/32
141.8.128.0/18
144.76.159.217/32
145.239.95.188/32
147.135.184.49/32
148.251.183.175/32
151.80.149.182/32
151.236.80.10/32
151.248.116.121/32
151.248.119.10/32
154.47.36.18/32
154.205.213.139/32
157.245.26.202/32
162.144.155.218/32
167.172.171.87/32
172.64.104.27/32
172.64.105.27/32
172.67.3.106/32
172.67.27.172/32
172.67.68.65/32
172.67.68.101/32
172.67.69.33/32
172.67.70.198/32
172.67.71.29/32
172.67.71.204/32
172.67.72.3/32
172.67.73.42/32
172.67.112.15/32
172.67.128.110/32
172.67.129.133/32
172.67.129.199/32
172.67.141.44/32
172.67.146.228/32
172.67.148.159/32
172.67.150.60/32
172.67.151.11/32
172.67.152.181/32
172.67.152.195/32
172.67.153.137/32
172.67.156.232/32
172.67.157.13/32
172.67.157.206/32
172.67.157.254/32
172.67.158.84/32
172.67.158.188/32
172.67.160.12/32
172.67.164.105/32
172.67.166.89/32
172.67.167.100/32
172.67.168.20/32
172.67.168.119/32
172.67.171.223/32
172.67.176.53/32
172.67.176.57/32
172.67.176.110/32
172.67.177.139/32
172.67.179.166/32
172.67.184.166/32
172.67.185.199/32
172.67.186.132/32
172.67.187.162/32
172.67.190.102/32
172.67.191.153/32
172.67.192.183/32
172.67.195.62/32
172.67.200.72/32
172.67.203.1/32
172.67.203.222/32
172.67.204.201/32
172.67.210.50/32
172.67.212.213/32
172.67.212.246/32
172.67.213.7/32
172.67.214.1/32
172.67.214.23/32
172.67.214.183/32
172.67.219.235/32
172.67.220.49/32
172.67.220.203/32
172.67.223.74/32
172.67.223.150/32
176.10.250.233/32
176.53.181.41/32
178.22.88.0/21
178.33.183.157/32
178.34.182.54/32
178.57.222.34/32
178.154.128.0/19
178.154.160.0/19
178.154.192.0/19
178.170.171.23/32
178.210.84.61/32
178.237.16.0/20
178.248.232.60/32
178.248.232.183/32
178.248.233.26/32
178.248.233.32/32
178.248.233.60/32
178.248.233.136/32
178.248.233.188/32
178.248.234.76/32
178.248.235.82/32
185.5.136.0/22
185.6.244.0/22
185.9.147.200/32
185.16.148.0/22
185.16.244.0/22
185.17.3.133/32
185.17.121.214/32
185.22.232.241/32
185.26.122.27/32
185.29.130.0/24
185.32.184.0/22
185.32.186.0/24
185.32.187.0/24
185.32.248.0/22
185.41.163.207/32
185.53.177.51/32
185.54.220.0/24
185.54.221.0/24
185.54.222.0/24
185.54.223.0/24
185.67.1.26/32
185.71.76.0/22
185.76.252.0/22
185.85.10.0/24
185.85.11.0/24
185.85.12.0/24
185.85.14.0/24
185.85.15.0/24
185.87.194.74/32
185.104.45.89/32
185.104.248.120/32
185.112.80.16/32
185.114.137.26/32
185.114.137.166/32
185.114.138.220/32
185.129.100.135/32
185.137.235.52/32
185.165.123.168/32
185.183.174.222/32
185.187.63.0/24
185.193.28.100/32
185.226.52.0/22
185.241.192.0/22
186.2.163.12/32
186.2.163.162/32
188.93.56.0/21
188.130.254.8/32
188.246.224.163/32
192.88.99.0/24
193.26.19.11/32
193.26.19.12/32
193.26.19.72/32
193.26.19.73/32
193.26.19.221/32
193.26.19.222/32
193.47.33.104/32
193.47.166.183/32
193.109.247.20/32
193.124.177.199/32
193.148.44.189/32
193.186.14.111/32
193.228.160.35/32
193.228.160.40/32
193.228.160.46/32
193.228.160.49/32
193.228.160.50/32
193.228.160.51/32
193.228.160.53/32
193.228.160.56/32
193.228.160.57/32
193.228.160.60/32
193.228.160.198/32
193.228.162.153/32
193.232.151.138/32
193.238.75.217/32
194.11.28.2/32
194.58.88.119/32
194.58.121.208/32
194.67.71.38/32
194.67.71.57/32
194.67.87.148/32
194.67.105.250/32
194.84.83.151/32
194.84.120.183/32
194.85.20.0/24
194.88.208.0/23
194.186.63.0/24
194.226.26.19/32
195.5.108.94/32
195.42.165.48/32
195.42.165.49/32
195.88.252.0/23
195.93.246.234/32
195.93.247.39/32
195.93.247.69/32
195.177.205.0/24
195.189.16.140/32
195.201.120.144/32
195.208.1.110/32
195.208.1.111/32
195.211.20.0/22
195.211.128.0/22
195.211.223.14/32
195.218.168.0/24
195.218.190.0/23
199.21.96.0/22
199.36.240.0/22
208.87.93.0/24
208.87.94.0/24
208.87.95.0/24
212.8.247.66/32
212.66.32.66/32
212.66.37.43/32
212.92.101.182/32
212.110.158.41/32
212.110.158.42/32
212.110.158.43/32
212.110.158.44/32
212.110.158.148/32
212.118.32.0/19
213.159.210.14/32
213.180.192.0/19
213.219.212.0/22
216.58.208.97/32
217.20.144.0/20
217.69.128.0/20
217.112.35.92/32
217.182.78.61/32
);

@def $ALLOWED_NETWORKS_V6 = (
2620:10f:d000::/44
2a02:6b8::/32
2a00:1148::/32
2a00:a300::/32
2a00:b4c0::/32
2a00:bdc0::/36
2a00:bdc0:e006::/48
2001:4860:4860::/112
2a00:bdc0:e003::/48
2a00:bdc0:e004::/46
2a00:bdc0:e008::/48
2a00:bdc0:f000::/36
2001:678:384::/48
2a02:5180::/32
2a03:2480::/33
2a04:4b40::/29
2a00:5a60::ad1:0ff/128
2a00:5a60::ad2:0ff/128
2a00:5a60::bad1:0ff/128
2a00:5a60::bad2:0ff/128
2a03:6f00:1::5c35:768c/128
2606:4700:20::ac43:469a/128
2606:4700:20::681a:26f/128
2606:4700:20::681a:36f/128
2a00:5a60::01:ff/128
2a00:5a60::02:ff/128
2600:1901:1:c36::/128
);


table filter {
  chain ZABORONA_V4 {
      daddr $ALLOWED_NETWORKS_V4 ACCEPT;
  }
  chain FORWARD {
      policy DROP;
      mod conntrack ctstate INVALID DROP;
      if $WAN_4 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT;
      if $VPN of $WAN_4 jump ZABORONA_V4;
  }
 }

table nat {
   chain POSTROUTING {
       saddr $VPN_ADDR_4 of $WAN_4 MASQUERADE;
   }
   chain PREROUTING {
        # Балансировка меджду демонами OpenVPN
       if $WAN_4 protocol tcp dport 1194 mod conntrack ctstate NEW mod statistic mode random probability 0.50000000000 REDIRECT to-ports 1195;
       if $WAN_4 protocol tcp dport 1196 mod conntrack ctstate NEW mod statistic mode random probability 0.50000000000 REDIRECT to-ports 1197;
       if $WAN_4 protocol udp dport 1194 mod conntrack ctstate NEW mod statistic mode random probability 0.50000000000 REDIRECT to-ports 1195;
       if $WAN_4 protocol udp dport 1196 mod conntrack ctstate NEW mod statistic mode random probability 0.50000000000 REDIRECT to-ports 1197;

       # Перенаправление DNS запросов на локальный серверв dnsmasq
       saddr 192.168.224.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
       }
      saddr 192.168.228.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
      saddr 192.168.232.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
      saddr 192.168.236.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
      saddr 192.168.240.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
      saddr 192.168.244.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
      saddr 192.168.248.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
      saddr 192.168.252.0/22 {
          protocol udp dport 53 REDIRECT;
          protocol tcp dport 53 REDIRECT;
      }
    }
}

# IPv6:
domain ip6 {
   table filter {
       chain ZABORONA_V6 {
           daddr $ALLOWED_NETWORKS_V6 ACCEPT;
       }
       chain FORWARD {
           policy DROP;
           mod conntrack ctstate INVALID DROP;
           if $WAN_6 of $VPN mod conntrack ctstate (ESTABLISHED RELATED) ACCEPT;
           if $VPN of $WAN_6 jump ZABORONA_V6;

       }
   }
}
